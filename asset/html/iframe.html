<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="css/iframe.css">
		<meta name="viewport" id="metaViewport" />
	</head>
	<body>
		<!-- <div id="eventCatcher"> -->
			<iframe id="overlayiframe" allowTransparency="true" frameborder="0" scrolling="no"></iframe>
		<!-- </div> -->
		<div id="debug"></div>
		
		<script type="text/javascript">
			
			function connectWebViewJavascriptBridge(callback) {
			    if (window.WebViewJavascriptBridge) {
			        callback(WebViewJavascriptBridge);
			    } else {
			        document.addEventListener('WebViewJavascriptBridgeReady', function() {
			            callback(WebViewJavascriptBridge);
			        }, false)
			    }
			}

			connectWebViewJavascriptBridge(function(bridge) {

			    // Init your app here
			    m.bridge = bridge;

			    bridge.init(function(message, responseCallback) {  
			        if (responseCallback) {
			        }
			    })

			    bridge.send({type: 'ready', value:'true'});
			});

			window.onerror = function (message, url, linenumber){
				//document.getElementById("debug").innerHTML += message + " line " + linenumber + " " + url + "</br>";
				alert('Javascript error: ' + message + ' on line ' + linenumber + ' for ' + url);
			}

        	console.log("Minko init");

			var m = {};

			m.bridge = null;
			m.loaded = -1;

			var iframeElement = document.getElementById('overlayiframe');
			m.iframeElement = iframeElement;

	        m.getOffsetTop = function(element)
			{
				var result = 0;
				while(element){
					result += element.offsetTop;
					element = element.offsetParent;
				}
				return result;
			};

			m.getOffsetLeft = function(element)
			{
				var result = 0;
				while(element){
					result += element.offsetLeft;
					element = element.offsetParent;
				}
				return result;
			};

			m.iframeLoadHandler = function(event)
			{
				console.log("loaded");

				if(Minko.loaded == -1)
					return;

				Minko.loaded = 1;
				if (!Minko.iframeElement.contentWindow.Minko)
					Minko.iframeElement.contentWindow.Minko = {};

				Minko.iframeElement.contentWindow.document.body.oncontextmenu = function(event)
				{ 
					event.preventDefault(); 
					return false;
				};

				if (!Minko.iframeElement.contentWindow.Minko.onmessage)
				{
					Minko.iframeElement.contentWindow.Minko.onmessage = function(message)
					{
						console.log('MINKO: ' + message);
					}
				}
				Minko.iframeElement.contentWindow.Minko.messagesToSend = [];

				Minko.iframeElement.contentWindow.Minko.sendMessage = function(message)
				{
					Minko.iframeElement.contentWindow.Minko.messagesToSend.push(message);
				}
			}

			iframeElement.onload = m.iframeLoadHandler;

			m.addListener = function(accessor, type)
			{
				if(!accessor.minkoEvents)
					accessor.minkoEvents = [];

				accessor.addEventListener(type, function(event)
				{
					accessor.minkoEvents.push(event);
					//alert('Client: ' + event.clientX + ', ' + event.clientY);
					//alert("addListener: " + type + '(layerX: ' + event.layerX + ', layerY: ' + event.layerY + ')|' + accessor.minkoName);
					//alert(accessor.minkoEvents);
					//console.log("addListener: " + type + '(layerX: ' + event.layerX + ', layerY: ' + event.layerY + ')|' + accessor.minkoName);
					//m.bridge.send({type: type, value: accessor.minkoName});
				});
			};

			m.getEventsCount = function(accessor)
			{
				if(accessor && accessor.minkoEvents)
					return accessor.minkoEvents.length;
				else
					return 0;
			};

			m.clearEvents = function(accessor)
			{
				if(accessor)
					accessor.minkoEvents = [];
			};

			m.loadUrl = function(url)
			{
				Minko.loaded = 0;
				iframeElement.src = url;

				console.log("loaded " + url);
			}

			m.changeViewportWidth = function(width)
			{
				var metaElement = document.getElementById("metaViewport");

				metaElement.setAttribute("content", "width=" + width);
			};

			window.Minko = m;
        </script>
	</body>
</html>